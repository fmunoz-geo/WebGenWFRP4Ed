<!DOCTYPE html>
<html lang="en">
<head>
    <title>Random Magic Grimoire Generator</title>
    <script>
        // Arcane spell list placeholder
        var AllArcane = [];
        var Arcane = [
            ["Aethyric Armour", 2],
            ["Aethyric Arms", 2],
            ["Arrow Shield", 3],
            ["Blast", 4],
            ["Bolt", 4],
            ["Breath", 6],
            ["Bridge", 4],
            ["Chain Attack", 6],
            ["Corrosive Blood", 4],
            ["Dark Vision", 1],
            ["Distracting", 4],
            ["Dome", 7],
            ["Drop", 1],
            ["Entangle", 3],
            ["Fearsome", 3],
            ["Flight", 3],
            ["Magic Shield", 4],
            ["Move Object", 4],
            ["Mundane Aura", 4],
            ["Push", 6],
            ["Teleport", 5],
            ["Terrifying", 7],
            ["Ward", 5]
        ];
        var ArcaneChaos = [
            ["Blast of Corruption", 8], ["Bolt of Corruption", 8], ["Daemonic Mien", 8],
            ["Foul Messenger", 8], ["Joyous Aspect", 4], ["Obsession", 8], 
            ["Power of Chaos", 4], ["Rend Aethyr", 16], ["Slave to Darkness", 8]
        ];
        var LoreSpells = {
            // Combined spells from all sources will be merged here
        };
        var LoreSpellsCore = {
            "Lore of Beasts": [["Amber Talons", 6], ["Beast Form", 5], ["Beast Master", 10], 
                ["Beast Tongue", 3], ["Flock of Doom", 8], ["Hunter’s Hide", 6], 
                ["The Amber Spear", 8], ["Wyssan’s Wildform", 8]],
            "Lore of Death": [["Caress of Laniph", 7], ["Dying Words", 6], ["Purple Pall of Shyish", 6],
                ["Sanctify", 6], ["Scythe of Shyish", 6], ["Soul Vortex", 8], 
                ["Steal Life", 7], ["Swift Passing", 6]],
            "Lore of Fire": [["Aqshy’s Aegis", 5], ["Cauterise", 4], ["Crown of Flame", 8], 
                ["Flaming Hearts", 8], ["Firewall", 6], ["Great Fires of U’Zhul", 10],
                ["Flaming Sword of Rhuin", 8], ["Purge", 10]],
            "Lore of Heavens": [["Cerulean Shield", 7], ["Comet of Casandora", 10],
                ["Fate’s Fickle Finger", 6], ["Starcrossed", 7], ["T’Essla’s Arc", 7],
                ["The First Portent of Amul", 3], ["The Second Portent of Amul", 6],
                ["The Third Portent of Amul", 12]],
            "Lore of Metal": [["Crucible of Chamon", 7], ["Enchant Weapon", 6],
                ["Feather of Lead", 5], ["Fool’s Gold", 4], ["Forge of Chamon", 9], ["Glittering Robe", 5], 
                ["Mutable Metal", 5], ["Transmutation of Chamon", 12]],
            "Lore of Life": [["Barkskin", 3], ["Earthblood", 6], ["Earthpool", 8], ["Fat of the Land", 4], ["Forest of Thorns", 6], 
                ["Lie of the Land", 5], ["Lifebloom", 8], ["Regenerate", 6]],
            "Lore of Light": [["Banishment", 12], ["Blinding Light", 5], ["Clarity of Thought", 6], ["Daemonbane", 10], 
                ["Healing Light", 9], ["Net of Amyntok", 8], ["Phâ\'s Protection", 10], ["Speed of Thought", 8]],
            "Lore of Shadows": [["Choking Shadows", 6], ["Doppelganger", 10], ["Illusion", 8],
                ["Mindslip", 6], ["Mystifying Miasma", 6], ["Shadowsteed", 6],
                ["Shadowstep", 8], ["Shroud of Invisibility", 8]],
            "Lore of Hedgecraft": [["Goodwill", 0], ["Mirkride", 0], ["Nepenthe", 0], ["Nostrum", 0],
                ["Part the Branches", 0], ["Protective Charm", 0]],
            "Lore of Witchcraft": [["Blight", 14], ["Creeping Menace", 6], ["Curse of Crippling Pain", 10],
                ["Curse of Ill-Fortune", 8], ["Haunting Horror", 8], ["The Evil Eye", 6]],
            "Lore of Daemonology": [["Destroy Lesser Daemon", 6], ["Detect Daemon", 4],
                ["Manifest Lesser Daemon", 8]],
            "Lore of Necromancy": [["Raise Dead", 8], ["Reanimate", 8], 
                ["Screaming Skull", 8], ["Vanhel’s Cal", 6]],
            "Lore of Nurgle": [["Stream of Corruption", 6]],
            "Lore of Slaanesh": [["Acquiescence", 5]],
            "Lore of Tzeentch": [["Treason of Tzeentch", 6]]
        };
        var LoreSpellsBloodAndBramble = {
            "Lore of Hedgecraft": [["Badwill", 0], ["Bonesetter", 0], ["Cleanslate", 0]],
            "Lore of Witchcraft": [["Banishment of Böl", 8], ["Bonesnapper", 6], ["Congeal", 4]],
            // (more spells)
        };
        var LoreSpellsSullasara = {
            "Lore of Beasts": [["Beast Made Well", 3], ["Cruelty’s Deserts", 2], ["Wyssan’s Ally", 4], 
                ["Wildercall", 2]],
            "Lore of Death": [["Stay Death’s Hand", 3], ["Deathsight", 2], ["Preservation", 5]],
            "Lore of Fire": [["Flashcook", 2], ["Comfort", 3], ["Ceaseless Flame", 2]],
            "Lore of Heavens": [["Birdspeech", 4], ["Weathervane", 2], ["Gale", 5]],
            "Lore of Metal": [["Tale of Metal", 3], ["Rigor of Steel", 3],["Sense Metal", 1]],
            "Lore of Life": [["Ferment", 3], ["Timbervault", 4], ["Track’s Tale Told", 3]],
            "Lore of Light": [["Cleansing Glow", 3], ["Disgust", 5], ["Illuminate", 3]],
            "Lore of Shadows": [["Shadows of Splendour", 4], ["Cloak Activity", 6], ["Pall of Darkness", 5]]
        };
        var LoreSpellsEnemyInShadowsCompanion = {
            "Lore of Tzeentch": [
                ["Boon of Tzeentch", 9], ["The Purple Hand", 3], ["Curse of Tzeentch", 9], 
                ["Blue Fire of Tzeentch", 6], ["Bolt of Change", 9], 
                ["The Flickering Flames of Fickle Fate", 4], ["Master of Fortune", 8],
                ["Mindfire", 6], ["Pink Fire of Tzeentch", 6], ["Sense the Skein", 3],
                ["Transformation of Tzeentch", 10], ["Tzeentch’s Firestorm", 11],
                ["Tzeentch’s Golden Aura", 7], ["Word of Tzeentch", 7]
            ]
        };

        // Spells from "Power Behind the Throne Companion"
        var LoreSpellsPowerBehindTheThroneCompanion = {
            "Lore of Slaanesh": [
                ["Acquiescence", 8], ["Aura of Acquiescence", 12], ["Bonds of Slaanesh", 8],
                ["Breath of Inspiration", 8], ["Blissful Throes", 6], ["Cacophonic Caress", 6],
                ["Careless Whispers", 8], ["Chaos Spawn", 10], ["Cursed Caress", 8], 
                ["Cutting Wit", 6], ["Delicious Excruciation", 6], ["Fleshy Curse", 10], 
                ["Flesh Puppet", 10], ["From Pain, Pleasure", 6], ["Lash of Slaanesh", 6],
                ["Gift of Slaanesh", 8], ["Luxurious Torment", 8], ["Mask of Desire", 8], 
                ["Pavane of Slaanesh", 8], ["Phantasmagoria", 8], ["Succubus’s Caress", 8], 
                ["Summon Daemonette", 12], ["Summon Daemonette Pack", 25], 
                ["Titillating Delusions", 8]
            ]
        };                
        var LORECOLOUR = {
            "Lore of Beasts": [["amber","brown","tan"]],
            "Lore of Death": [["purple","black","dark"]],
            "Lore of Fire": [["red","orange","yellow"]],
            "Lore of Heavens": [["blue","celeste","silver"]],
            "Lore of Metal": [["golden","yellow","bronze"]],
            "Lore of Life": [["green","jade","tan"]],
            "Lore of Light": [["white","silver","ivory"]],
            "Lore of Shadows": [["black","dark","grey"]],
            "Lore of Hedgecraft": [["green","brown","tan","black"]],
            "Lore of Witchcraft": [["black","purple","red","blue","white","dark grey"]],
            "Lore of Daemonology": [["black","purple","red","blue","white","dark grey"]],
            "Lore of Necromancy":  [["black","purple","red","blue","white","dark grey"]],
            "Lore of Nurgle": [["green","brown","tan","black"]],
            "Lore of Slaanesh": [["pink","purple","black","dark"]],
            "Lore of Tzeentch": [["blue","celeste","silver","gold","multicoloured"]]
        };
        var LOREMATERIAL = {
            "Lore of Beasts": [["hide", "$COLOUR leather", "fur covered", "bone covered"]],
            "Lore of Death": [["$COLOUR velvet", "$COLOUR silk", "bone covered"]],
            "Lore of Fire": [["iron covered","darkened $COLOUR leather","charred $COLOUR cloth"]],
            "Lore of Heavens": [["$COLOUR silk", "$COLOUR velvet"]],
            "Lore of Metal": [["gold covered", "$COLOUR metal covered"]],
            "Lore of Life": [["jade covered", "$COLOUR cloth", "wood covered"]],
            "Lore of Light": [["$COLOUR cloth","silver covered","ivory covered"]],
            "Lore of Shadows": [["velvet","silk","canvas"]],
            "Lore of Hedgecraft": [["plain canvas","wood covered"]],
            "Lore of Witchcraft": [["$COLOUR leather"]],
            "Lore of Daemonology": [["$COLOUR velvet","$COLOUR silk","bone covered","extrange $COLOUR leather"]],
            "Lore of Necromancy":  [["bone covered", "extrange $COLOUR leather"]],
            "Lore of Nurgle": [["moist $COLOUR leather","rotting $COLOUR leather","rotting $COLOUR hide"]],
            "Lore of Slaanesh": [["supple $COLOUR leather","$COLOUR silk","$COLOUR velvet"]],
            "Lore of Tzeentch": [["$COLOUR velvet","$COLOUR silk","bone covered","extrange $COLOUR leather","gold","$COLOUR metal","$COLOUR wood","$COLOUR bone","$COLOUR parchment"]]
        };
        // Colors and book decorations
        var COLOUR = [
            "$LORECOLOUR", "$LORECOLOUR", "$LORECOLOUR", "black",
            "purple", "red", "blue", "white", "dark gray", 
            "yellow", "tan", "green", "brown"
        ];

        var BOOKDECORATION = [
            "",
            "", // Empty string for no decoration
            ", within it are a few pressed flowers",
            " with a few $COLOUR ribbons to bookmark it",
            " with a few $COLOUR strings to bookmark it",
            " with strange illuminations in the margins",
            " with a few $COLOUR feathers tucked inside",
            " with a hefty lock and key to keep it closed",
            " with a few $COLOUR gems embedded in the cover",
            " with an ilegible ex-libris on its first page"
        ];
        var BOOKCOVERMATERIAL = [
            "$LOREMATERIAL", "$LOREMATERIAL", "$LOREMATERIAL", "$COLOUR leather", "$COLOUR parchment", 
            "$COLOUR silk", "$COLOUR velvet", "$COLOUR canvas", "wooden covered", "thin metal covered"
        ];
        var BOOKLOOKS = [
            "old and worn", "new and pristine", "well-used", "well-loved", "ancient", "dog-eared"
        ];

        // ALLSTRINGS array to map placeholders to arrays
        var ALLSTRINGS = [
            ["$COLOUR", COLOUR],
            ["$BOOKCOVERMATERIAL", BOOKCOVERMATERIAL],
            ["$BOOKLOOKS", BOOKLOOKS],
            ["$BOOKDECORATION", BOOKDECORATION]
        ];
        
        var BOOK = [
            "A $BOOKLOOKS $BOOKCOVERMATERIAL book $BOOKDECORATION",
        ];

        // Helper function to generate random number between min and max (inclusive)
        function randomBetween(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function removedoublespaces (str) {
            str = str.replace(/ +(?= )/g,'');
            str = str.replace(/ \./g,'.');
            return str;
        }

        function aanmanagement( str) {
            var strnew = str.replace(/\b(a)\s([aeiou])/ig,'$1n $2');
            strnew = strnew.replace(/\b(a)\s<I>([aeiou])/ig,'$1n <I>$2');
            return strnew;
        }

        // Helper function to randomly select N spells from a given list
        function getRandomSpells(spellList, count) {
            let spells = [];
            while (spells.length < count) {
                let spell = spellList[randomBetween(0, spellList.length - 1)];
                if (!spells.includes(spell)) { // Avoid duplicates
                    spells.push(spell);
                }
            }
            return spells;
        }
        function mergeSpells(chosenLore) {
            // Reset LoreSpells
            LoreSpells = {};
            AllArcane = Arcane;

            // Always include the base Rulebook spells
            Object.keys(LoreSpellsCore).forEach(lore => {
                if (!LoreSpells[lore]) LoreSpells[lore] = [];
                LoreSpells[lore] = LoreSpells[lore].concat(LoreSpellsCore[lore]);
            });

            // If "Blood and Bramble" is selected, merge those spells
            if (document.getElementById("bloodAndBramble").checked) {
                Object.keys(LoreSpellsBloodAndBramble).forEach(lore => {
                    if (!LoreSpells[lore]) LoreSpells[lore] = [];
                    LoreSpells[lore] = LoreSpells[lore].concat(LoreSpellsBloodAndBramble[lore]);
                });
            }
            if (document.getElementById("sullasaraSpells").checked) {
                Object.keys(LoreSpellsSullasara).forEach(lore => {
                    if (!LoreSpells[lore]) LoreSpells[lore] = [];
                    LoreSpells[lore] = LoreSpells[lore].concat(LoreSpellsSullasara[lore]);
                });
            }
            // If "Enemy in Shadows Companion" is selected, merge those spells
            if (document.getElementById("enemyInShadows").checked) {
                Object.keys(LoreSpellsEnemyInShadowsCompanion).forEach(lore => {
                    if (!LoreSpells[lore]) LoreSpells[lore] = [];
                    LoreSpells[lore] = LoreSpells[lore].concat(LoreSpellsEnemyInShadowsCompanion[lore]);
                });
                if (chosenLore === "Lore of Nurgle" || chosenLore === "Lore of Slaanesh" || chosenLore === "Lore of Tzeentch") {
                    AllArcane = Arcane.concat(ArcaneChaos);  // Add Arcane Chaos spells to the Arcane spell list
                }
            }

            // If "Power Behind the Throne Companion" is selected, merge those spells
            if (document.getElementById("powerBehindThrone").checked) {
                Object.keys(LoreSpellsPowerBehindTheThroneCompanion).forEach(lore => {
                    if (!LoreSpells[lore]) LoreSpells[lore] = [];
                    LoreSpells[lore] = LoreSpells[lore].concat(LoreSpellsPowerBehindTheThroneCompanion[lore]);
                });
            }            
        }
        // Function to generate a random grimoire
        function generateGrimoire() {

            // Get the chosen Lore
            let loreNames = Object.keys(LoreSpells);
            let chosenLore = document.getElementById("loreSelect").value;
            if (chosenLore === "Random") {
                let loreNames = Object.keys(LoreSpellsCore);
                chosenLore = loreNames[randomBetween(0, loreNames.length - 1)];
            }
            console.log("Chosen Lore: " + chosenLore);
            // Call mergeSpells to update LoreSpells based on user selections
            mergeSpells(chosenLore); 
            // Determine the number of spells (4-8) with weighted probabilities
            let spellCount = getSpellCount();

            // Get the spells: mix between Arcane and the specific Lore spells
            let arcaneSpells = getRandomSpells(AllArcane, Math.max(randomBetween(1, spellCount - 1), spellCount - LoreSpells[chosenLore].length)); // At least one Arcane spell
            let loreSpells = getRandomSpells(LoreSpells[chosenLore], spellCount - arcaneSpells.length);

            let allSpells = arcaneSpells.concat(loreSpells);

            // Create the grimoire text
            let grimoireText = "Grimoire of " + chosenLore + ":\n";
            allSpells.forEach(spell => {
                grimoireText += `- ${spell[0]} (CN: ${spell[1]})\n`;
            });

            // Add random decoration
            grimoireText += "\nAppearance: " + aanmanagement(removedoublespaces(generateBookAppearance(chosenLore)));

            // Display the generated grimoire
            document.getElementById("grimoire").textContent = grimoireText;
        }

        // Function to get spell count with weighted probabilities
        function getSpellCount() {
            let random = Math.random();
            if (random < 0.30) return 4;
            if (random < 0.55) return 5;
            if (random < 0.75) return 6;
            if (random < 0.90) return 7;
            return 8;
        }

        // Function to generate a random book appearance
        function generateBookAppearance(chosenLore) {
            let template = getRandomElement(BOOK);
            return replacePlaceholders(template, chosenLore);
        }

        // Helper function to get a random element from an array
        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function replacePlaceholders(originalString, chosenLore) {
            let notdone = true;

            while (notdone) {
                notdone = false;

                // Handle LOREXXXXX placeholders first
                if (originalString.includes("$LORECOLOUR")) {
                    const replacement = getRandomElement(LORECOLOUR[chosenLore][0]);
                    originalString = originalString.replace("$LORECOLOUR", replacement);
                    notdone = true;
                }
                if (originalString.includes("$LOREMATERIAL")) {
                    const replacement = getRandomElement(LOREMATERIAL[chosenLore][0]);
                    originalString = originalString.replace("$LOREMATERIAL", replacement);
                    notdone = true;
                }


                // Replace other placeholders using ALLSTRINGS
                for (let i = 0; i < ALLSTRINGS.length; i++) {
                    let lookingFor = ALLSTRINGS[i][0];
                    let possibleValues = ALLSTRINGS[i][1];

                    if (originalString.includes(lookingFor)) {
                        const replacement = getRandomElement(possibleValues);
                        originalString = originalString.replace(lookingFor, replacement);
                        notdone = true;
                    }
                }
            }

            return originalString;
        }
        
        // Function to generate a random book appearance
        function generateBookAppearance(chosenLore) {
            let template = BOOK[randomBetween(0, BOOK.length - 1)];
            return replacePlaceholders(template, chosenLore);
        }

    </script>
</head>
<body>
    <h1>Random Magic Grimoire Generator</h1>
    <label for="loreSelect">Select Lore:</label>
    <select id="loreSelect">
        <option value="Random" selected="selected">Random</option>
        <option value="Lore of Beasts">Lore of Beasts</option>
        <option value="Lore of Death">Lore of Death</option>
        <option value="Lore of Fire">Lore of Fire</option>
        <option value="Lore of Heavens">Lore of Heavens</option>
        <option value="Lore of Metal">Lore of Metal</option>
        <option value="Lore of Life">Lore of Life</option>
        <option value="Lore of Light">Lore of Light</option>
        <option value="Lore of Shadows">Lore of Shadows</option>
        <option value="Lore of Hedgecraft">Lore of Hedgecraft</option>
        <option value="Lore of Witchcraft">Lore of Witchcraft</option>
        <option value="Lore of Daemonology">Lore of Daemonology</option>
        <option value="Lore of Necromancy">Lore of Necromancy</option>
        <option value="Lore of Nurgle">Lore of Nurgle</option>
        <option value="Lore of Slaanesh">Lore of Slaanesh</option>
        <option value="Lore of Tzeentch">Lore of Tzeentch</option>
    </select>
    <div>
        <label><input type="checkbox" id="bloodAndBramble" value="Blood and Bramble"> Include <a href="https://www.drivethrurpg.com/es/product/305317/warhammer-fantasy-role-play-blood-and-bramble?affiliate_id=91369">"Blood and Bramble"</a> Expansion</label><br>
        <label><input type="checkbox" id="sullasaraSpells" value="Sullasara’s Spells"> Include <a href="https://www.drivethrurpg.com/es/product/354584/warhammer-fantasy-role-play-sullasara-s-spells-of-unrivalled-utility?affiliate_id=91369">"Sullasara’s Spells of Unrivaled Utility"</a> Expansion</label><br>
        <label><input type="checkbox" id="enemyInShadows" value="Enemy in Shadows"> Include <a href="https://www.drivethrurpg.com/es/product/293881/warhammer-fantasy-roleplay-enemy-in-shadows-companion?affiliate_id=91369">"Enemy in Shadows Companion"</a> Expansion</label><br>
        <label><input type="checkbox" id="powerBehindThrone" value="Power Behind the Throne"> Include <a href="https://www.drivethrurpg.com/es/product/303926/warhammer-fantasy-role-play-power-behind-the-throne-companion?affiliate_id=91369">"Power Behind the Throne Companion"</a> Expansion</label>
    </div>
    <button type="button" onclick="generateGrimoire()">Generate Grimoire</button>
    <pre id="grimoire"></pre> <!-- 'pre' to preserve formatting of the output -->
    <p id="Acknowledgements">Code: Francisco Mu&ntilde;oz 2024.
        <br>Based on the Grimoires entry on page 238, and the spell lists of the <a href="https://www.drivethrurpg.com/product/248284/Warhammer-Fantasy-Roleplay-Fourth-Edition-Rulebook?affiliate_id=91369">Warhammer Fantasy Roleplay Fourth Edition Rulebook</a>.
        <br>Based on the spell lists of <a href="https://www.drivethrurpg.com/es/product/354584/warhammer-fantasy-role-play-sullasara-s-spells-of-unrivalled-utility?affiliate_id=91369">Sullasara’s Spells of Unrivaled Utility</a>.
        <br>Based on the spell lists of <a href="https://www.drivethrurpg.com/es/product/305317/warhammer-fantasy-role-play-blood-and-bramble?affiliate_id=91369">Blood and Bramble</a>.
        <br>Based on the spell lists of <a href="https://www.drivethrurpg.com/es/product/293881/warhammer-fantasy-roleplay-enemy-in-shadows-companion?affiliate_id=91369">Enemy in Shadows Companion</a>.
        <br>Based on the spell lists of <a href="https://www.drivethrurpg.com/es/product/303926/warhammer-fantasy-role-play-power-behind-the-throne-companion?affiliate_id=91369">Power Behind the Throne Companion</a>.
        <br>Inspiration: <a href="http://www.windsofchaos.com/wp-content/uploads/encroachment/html/generator-random-treasure-01.html">Encroatchment of Chaos, Treasure Generator by Dave Graffam</a>.
        <br>Inspiration: <a href="http://orteil.dashnet.org/randomgen/?gen=https://pastebin.com/raw/JcxC8pMx">WFRP 4e Equipment Generator</a>.
        <br>Inspiration: <a href="https://ratujmywfrp2pl.files.wordpress.com/2010/01/treasure-tables.pdf">Dan White's WFRP RANDOM TREASURE GENERATION</a>.
        <br>Inspiration: <a href="http://www.goatmansgoblet.com/2020/08/warhammer-fantasy-apothecary.html">Goatman's Goblet: WFRP The Apothecary (Trappings/Randomizers)</a>.
        <br>Game: Games Worshop and Cubicle 7
        <br>Other random generators: <a href="https://randroll.com/archive/warhammer-fantasy-roleplay-generators-guide/">https://randroll.com/archive/warhammer-fantasy-roleplay-generators-guide/</a></p>
</body>
</html>
